<div class="container-fluid py-4">
  <!-- Layout en deux colonnes : sidebar + contenu -->
  <div class="row g-4">

    <!-- Sidebar (fixe à gauche sur grand écran) -->
    <div class="col-lg-3 col-xxl-2 d-none d-lg-block">
      <div class="sticky-top" style="top: 1rem;">
        <app-admin-menu></app-admin-menu>
      </div>
    </div>

    <!-- Contenu principal -->
    <div class="col-lg-9 col-xxl-10">

      <h2 class="h4 mb-4">Gestion des demandes de dons</h2>

      <!-- Loading -->
      @if (loading) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-3 text-muted">Chargement des demandes...</p>
        </div>
      }

      <!-- Tableau -->
      @else {
        <div class="card shadow-lg border-0">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-header">
                  <tr>
                    <th>Demandeur</th>
                    <th>Titre</th>
                    <th>Description</th>
                    <th>Montant</th>
                    <th>Annexe</th>
                    <th>Date</th>
                    <th>Statut</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>

                  @for (d of demandes; track d._id) {
                    <tr>
                      <td>
                        <strong>{{ d.createdBy.prenom }} {{ d.createdBy.nom }}</strong><br>
                        <small class="text-muted">{{ d.createdBy.email }}</small>
                      </td>
                      <td><strong>{{ d.title }}</strong></td>
                      <td>
                        <div class="text-truncate" style="max-width: 280px;">
                          {{ d.description }}
                        </div>
                      </td>
                      <td><strong>{{ d.montant | currency:'XAF':'symbol':'4.0-4' }}</strong></td>
                      <td>
                        @if (d.annexe) {
                          <a [href]="getFileUrl(d.annexe)" target="_blank" class="text-decoration-none d-inline-block">
                            @if (isImage(d.annexe)) {
                              <img [src]="getFileUrl(d.annexe)" alt="Annexe"
                                   class="img-thumbnail rounded"
                                   style="width: 70px; height: 70px; object-fit: cover; transition: transform .2s;"
                                   (mouseenter)="$any($event.currentTarget).style.transform='scale(4)'"
                                   (mouseleave)="$any($event.currentTarget).style.transform='scale(1)'">
                            } @else if (isPdf(d.annexe)) {
                              <div class="text-center">
                                <i class="bi bi-file-earmark-pdf-fill text-danger fs-1"></i>
                                <small class="d-block text-danger">PDF</small>
                              </div>
                            }
                          </a>
                        } @else {
                          <span class="text-muted fst-italic">Aucun fichier</span>
                        }
                      </td>
                      <td>{{ d.dateDemande | date:'dd/MM/yyyy HH:mm' }}</td>
                      <td>
                        <span class="badge rounded-pill px-3 py-2 fw-semibold"
                              [ngClass]="getStatutClass(d.statut)">
                          {{ d.statut === 'EN_ATTENTE' ? 'En attente' : d.statut === 'ACCEPTEE' ? 'Acceptée' : 'Refusée' }}
                        </span>
                      </td>
                      <td>
                        @if (d.statut === 'EN_ATTENTE') {
                          <div class="btn-group" role="group">
                            <button class="btn btn-success btn-sm rounded-start-1"
                                    title="Accepter"
                                    (click)="updateStatut(d._id, 'ACCEPTEE')">
                              <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn btn-danger btn-sm rounded-end-1"
                                    title="Refuser"
                                    (click)="updateStatut(d._id, 'REFUSEE')">
                              <i class="bi bi-x-lg"></i>
                            </button>
                          </div>
                        } @else {
                          <span class="text-muted small">—</span>
                        }
                      </td>
                    </tr>
                  }

                  @empty {
                    <tr>
                      <td colspan="8" class="text-center py-5">
                        <div class="text-muted">
                          <i class="bi bi-inbox fs-1"></i>
                          <p class="mt-3 mb-0">Aucune demande de don pour le moment.</p>
                        </div>
                      </td>
                    </tr>
                  }

                </tbody>
              </table>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>
