<div class="dashboard-container">
  
  <div class="main-content">
    <div class="input-help-container">
      <!-- Section input à gauche -->
      <div class="input-section">
        <div class="sheet-loader">
          <input
            type="text"
            [(ngModel)]="spreadsheetId"
            placeholder="Collez le SPREADSHEET_ID du Google Sheet"
            class="input-sheet"
          >
          <button (click)="importerDemandes()" class="btn-primary">
            <lord-icon
              src="https://cdn.lordicon.com/msoeawqm.json"
              trigger="hover"
              colors="primary:#ffffff"
              style="width:24px;height:24px">
            </lord-icon>
            Charger les données</button>
        </div>
      </div>

      <!-- Section aide à droite -->
      <div class="help-section">
        <div class="help-header">
          <h3><i class="icon-help"></i> Comment trouver l'ID ?</h3>
        </div>

        <div class="help-content">
          <div class="help-steps">
            <div class="step">
              <span class="step-number">1</span>
              <span>Ouvrez votre Google Sheet</span>
            </div>
            <div class="step">
              <span class="step-number">2</span>
              <span>Copiez l'URL depuis la barre d'adresse</span>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <span>Repérez la partie entre <strong>/d/</strong> et <strong>/edit</strong></span>
            </div>
            <div class="step">
              <span class="step-number">4</span>
              <span>Collez cet ID dans le champ à gauche</span>
            </div>
          </div>

          <div class="help-note">
            <i class="icon-info"></i>
            <span>Sheet doit être partagé en mode "Lecture publique"</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Affichage seulement si la liste n'est pas vide -->
    @if (demandes.length) {
    <div class="table-container">
      <!-- En-tête avec informations -->
      <div class="table-header">
        <h2 style="font-size: 22px;font-weight: bold;color: #1E3A5F;">Liste des étudiants</h2>
        <div class="table-info">
          <span>Total :  {{demandes.length}} demandes</span>
           @if (currentPage > 0) { 
            <span>Page</span>
          } 
        </div>
      </div>
<!-- filtre -->
<div class="filter-buttons">
  <button class="btn filter-btn" (click)="showAll()">Toutes</button>
   <button class="btn filter-btn" (click)="showEncours()">En cours</button>

  <button class="btn filter-btn" (click)="showAcceptes()">Acceptées</button>
  <!-- <button class="btn filter-btn" (click)="showRefusees()">Refusées</button> -->
   
</div>


      <!-- Tableau -->
      <table class="table">
        <thead>
          <tr>
            <th>Nom</th>
              <th>Prénom</th>
              <th>Email</th>
              <th>Club</th>
              <th>Date Demande</th>
              <th>Statut</th>
              <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @for (d of getPaginatedDemandes(); track d._id) { 
            <tr>
              <td>{{ d.etudiant.lastName || 'n' }}</td>
              <td>{{ d.etudiant.firstName }}</td>
              <td>{{ d.etudiant.email }}</td>
              <td>{{ d.club.nom }}</td>
              <td>{{ d.dateDemande | date: 'short' }}</td>
              <td>
  <span [ngClass]="{
    'statut attente': d.statut === 'en attente',
    'statut acceptee': d.statut === 'acceptée',
    'statut refusee': d.statut === 'refusée'
  }">
    {{ d.statut }}
  </span>
</td>

              <td>
                <!--  (click)="envoyerMail(e)" -->
                <button class="btn-action"  (click)="openModal(d)">
                   <i class="icon-mail"></i>  
                  Envoyer Mail
                </button>
              </td>
            </tr>
           } 
        </tbody>
      </table>
  
      <!-- Pagination -->
       @if(totalPages > 1) {
        <div class="pagination">
          <button  
           (click)="previousPage()" [disabled]="currentPage === 0" 
            class="pagination-btn">
            <i class="icon-arrow-left"></i> Précédent
          </button>

          <div class="page-numbers">
           @for (page of getPageNumbers(); track $index) {
              <span 
               (click)="goToPage(page)"
                  [class.active]="page === currentPage"
              class="page-number">
                {{ page + 1 }}
              </span>}  
          </div>
          <button
            (click)="nextPage()" [disabled]="currentPage === totalPages - 1" class="pagination-btn">
            Suivant <i class="icon-arrow-right"></i>
          </button>
        </div>}
      
    </div>
    } @else {
    <!-- Message si aucune donnée -->
    <div class="no-data">
      <div class="no-data-icon">
        <i class="icon-no-data"></i>
      </div>
      <p>Aucun étudiant trouvé.</p>
      <p class="no-data-hint">Veuillez charger les données depuis un Google Sheet.</p>
    </div>
    }
  </div>
</div>
<!-- ===================== MODAL ENVOI DATES ===================== -->
@if (showModal) {
  <div class="modal-overlay">
    <div class="modal-container">
      <h3>Proposer des créneaux pour {{ activeDemande?.etudiant?.firstName }} {{ activeDemande?.etudiant?.lastName }}</h3>

      <div class="date-fields">
        @for (date of dateInputs; track $index) {
          <div class="date-row">
            <input type="datetime-local" [(ngModel)]="dateInputs[$index]" />
           <button (click)="removeDateField($index)" class="btn-remove">✕</button>

          </div>
        }
      </div>

      <button (click)="addDateField()" class="btn-add">+ Ajouter une date</button>

      <div class="modal-actions">
        <button (click)="envoyerDates()" class="btn-primary">Envoyer Email</button>
        <button (click)="closeModal()" class="btn-secondary">Annuler</button>
      </div>
    </div>
  </div>
}
@if (showStatutModal) {
  <div class="modal-overlay">
    <div class="modal-container">
      <h3>{{ modalTitle }}</h3>

      <!-- Vérifier s'il y a des étudiants -->
      @if (modalDemandes.length > 0) {
        <table class="table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Prénom</th>
              @if (filterStatus === 'acceptée') {
                <th>Date choisie</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (d of modalDemandes; track d._id) {
              <tr>
                <td>{{ d.etudiant.lastName }}</td>
                <td>{{ d.etudiant.firstName }}</td>
                @if (filterStatus === 'acceptée') {
                  <td>{{ d.dateChoisie | date:'short' }}</td>
                }
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <p>Aucun étudiant trouvé.</p>
      }

      <div class="modal-actions mt-3">
        <button class="btn btn-secondary" (click)="closeStatutModal()">Fermer</button>
      </div>
    </div>
  </div>
}
